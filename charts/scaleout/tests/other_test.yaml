suite: Ignition Scaleout Other Resources
templates:
  - secrets.yaml
  - serviceaccount.yaml
tests:
  # Secret Tests
  - it: should create plain Secrets by default
    template: secrets.yaml
    asserts:
      - documentIndex: 0
        isKind:
          of: Secret
      - documentIndex: 0
        matchRegex:
          path: metadata.name
          pattern: -frontend-secrets$
      - documentIndex: 1
        isKind:
          of: Secret
      - documentIndex: 1
        matchRegex:
          path: metadata.name
          pattern: -backend-secrets$

  - it: should create SealedSecrets when enabled
    template: secrets.yaml
    set:
      frontend:
        sealedSecrets: true
        secrets: { FRONTEND_SEC: "enc1" }
      backend:
        sealedSecrets: true
        secrets: { BACKEND_SEC: "enc2" }
    asserts:
      - documentIndex: 0
        isKind:
          of: SealedSecret
      - documentIndex: 0
        equal:
          path: spec.encryptedData.FRONTEND_SEC
          value: "enc1"
      - documentIndex: 1
        isKind:
          of: SealedSecret
      - documentIndex: 1
        equal:
          path: spec.encryptedData.BACKEND_SEC
          value: "enc2"

  # ServiceAccount Tests
  - it: should not create ServiceAccount by default
    template: serviceaccount.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ServiceAccount when enabled
    template: serviceaccount.yaml
    set:
      serviceAccount:
        create: true
        name: scaleout-sa
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: scaleout-sa
